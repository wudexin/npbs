package com.nantian.npbs.test.gateway.camel;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;
import java.net.UnknownHostException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.nantian.npbs.common.utils.ConvertUtils;

public class SocketClient {
	private static final Logger logger = LoggerFactory
			.getLogger(SocketClient.class);

	private final static ThreadLocal<Socket> sockPool = new ThreadLocal<Socket>();

	/** 决定客户端采用长连接还是短连接的方式 */
	private static final boolean KEEP_CONNECTION = false;

	public static void main(String args[]) throws Exception {
	
		SocketClient sc = new SocketClient();
		byte[] body = null;
		String  payHexString = null;		
		payHexString = sc.getPosPackByTradeCode("008002");
		body = ConvertUtils.hexStr2Bytes(payHexString);
		sendSopBuffer(body);	

	}

	public static byte[] sendSopBuffer(byte[] buf) throws Exception {

		// 通过Socket连接服务器
		Socket server = getSocket();

		// 创建网络输出流输出内容到服务器上
		OutputStream netOut = server.getOutputStream();
		OutputStream dataOut = new BufferedOutputStream(netOut);

		byte[] serverbuf = new byte[2048];

		try {
			dataOut.write(buf, 0, buf.length);// 把文件数据写出网络缓冲区
			dataOut.flush();// 刷新缓冲区把数据写往服务器端

			InputStream netIn = server.getInputStream();
			InputStream dataIn = new BufferedInputStream(netIn);

			int servernum = dataIn.read(serverbuf);
			logger.info("从服务器读取的数据长度：{}" , servernum);
			if (servernum <= 0)
				throw new Exception("未能从前置读取有效数据！");

			/*
			 * while (servernum != (-1)) {
			 * logger.debug("continue reading from socket..."); servernum =
			 * dataIn.read(serverbuf);// 继续从网络中读取数据 }
			 */

			// 得到成功标志
			byte[] tmp = new byte[servernum];
			for (int i = 0; i < servernum; i++) {
				tmp[i] = serverbuf[i];
			}
			logger.info("result:{}" ,new String(tmp));
			String ansHexString = ConvertUtils.bytes2HexStr(tmp);
			logger.info("result-hex, length[:{}]:{}" , ansHexString.length() , ansHexString);

		} catch (Exception e) {
			closeSocket();
			throw (e);
		} finally {
			if (!KEEP_CONNECTION) {
				closeSocket();
			}
		}

		return serverbuf;
	}

	private static Socket getSocket() throws UnknownHostException, IOException {
		Socket s = (Socket) sockPool.get();
		if (s == null || s.isClosed()) {
			logger.debug("s==null is " + (s == null));
			if (s != null)
				logger.debug("is closed:" + s.isClosed());
			s = reconnect();
			sockPool.set(s);
		}
		logger.info("Socket= {}" + s.hashCode());
		return s;
	}

	private static Socket reconnect() throws UnknownHostException, IOException {
		logger.debug("recreating socket...");
		String serverIp = "127.0.0.1";	
		int serverPort = 8884;
		/*String serverIp = "10.232.6.210";
		int serverPort = 8884;*/
		Socket s = new Socket(serverIp, serverPort);
		s.setSoTimeout(10000000);
		logger.debug("socket recreated");
		return s;
	}

	public static void closeSocket() throws IOException {
		Socket s = (Socket) sockPool.get();
		sockPool.set(null);
		if (s != null && !s.isClosed()) {
			s.close();
		}
	}
	
	public String getPosPackByTradeCode(String tradeCode) {
		if("012001".equals(tradeCode)) {
			return "01aa600018000060220000087502000020000100c08211000249001230303030303032343334383720202020202020202020202020202020202020203035353130303237202020202020202020202020313536033231303131303630303030323434414236333042443536323034343439354438343836464432324543304137433237413334364235314630464430444531304334443433453045443036334144303137454645363134453638423144364337363630333838303941393544373339383531434630454142423842434332374133383132313738373042463932414143323045323445343333354539393043374436333741413831464437363041453241304242464236383643384533443745383531314131363233373146344442454235383435384233314636443443343934373743414642353344353435303831354338423143344644433631413836334332363534363742384433434146433245443031393441304341333146324343314435363030303030303234333438373030303030303233393435343033303030303030303030303030303036340120014070aaee7dafd5f5";
		}else if ("012002".equals(tradeCode)) {
			return "02a260001800006022000008750200502200810cc0921100000000000100000047313030303030303030303030303030300000001203070002127506b6c5c1a2b7e52020202020202020202020202020202020202020303731303030303120202020202020202020202031353677192257e4ba27990546313031313037303030303134344241313443323336304238303643303539444243324137333438443534353136464445343834443336344137373738363531333646463535393145454144393138423435423241414531453144453645444630443738424446454543303233463631314231303930414635343934443537324237364243353745434237333645393137314331374536444539453245374246454645353636463042433335383537454441383142333430464430393642364433303930393330433345314133383833333435414541373046463239343333454130343646444245344536333843453337414241304646344141373044453842394441443139353845324341424230374430303030303030303030303030303030303030303736373935363836373430303130303030383735373530323030303030303334303030303033453830323735333137333836202020202020b6c5c1a2b7e5202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020b6abc8fdbdccb4f3bdd6bbaab3c7c2ccd6ded0a1c7f8332d332d3135303320202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020203031303030303030303030303030302e303030303030302e30303133343031202020202020202020202030323030302e303030303030302e30300120027d327840fee026c1";
		}else if("012023".equals(tradeCode)) {
			return "01d2600018000060100000000002000022008108c082190000163130303030303030303030303030303000001230303030303032343334383712030700021847313131312020202020202020202020202020202030353531303032372020202020202020202020203135360332313031313036303030303234344142363330424435363230343434393544383438364644323245433041374332374133343642353146304644304445313043344434334530454430363341443031374546453631344536384231443643373636303338383039413935443733393835314346304541424238424343323741333831323137383730424639324141433230453234453433333545393930433744363337414138314644373630414532413042424642363836433845334437453835313141313632333731463444424542353834353842333146364434433439343737434146423533443534353038313543384231433446444336314138363343323635343637423844334341464332454430314234303046464142434344333842444230303030303032343334383730303030303032333934353430333030303030303135303030303639303001202300143132303330373030303231383437e3b1fd347f07480f";
		}else if("012012".equals(tradeCode)){
			return "01bf600018000060220000087502005020000100c0821900000000000500000085001030323735333137333836202020202020202020202020202020202020202030373130303030312020202020202020202020203135360332313031313037303030303134344241313443323336304238303643303539444243324137333438443534353136464445343834443336344137373738363531333646463535393145454144393138423435423241414531453144453645444630443738424446454543303233463631314231303930414635343934443537324237364243353745434237333645393137314331374536444539453245374246454645353636463042433335383537454441383142333430464430393642364433303930393330433345314133383833333435414541373046463239343333454130343646444245344536333843453337414241304646344141373044453842394441443139353845324341424230374430303137453639364546443645363844413530303736373935363836373430303130303030383735373530323030303030303339303030303031463401201200143132303330373030303231393435f526afabd11c4778";			
		}else if("010001".equals(tradeCode)){
			return "012a600018000060220000087502000020000100c082110003120016303138463942353131393635323544364d4f44454d3a2020202000002020202020202020303535313030323720202020202020202020202031353602003437333432343030303030303139303330303030323541363743463332314139374545453031384639423531313936353235443630303030303030303030303030303030303030333030303030303539303030303030353930303030303030303030303030303030303130303030303030303030303030303030303030303030303030303030303030303030303030302020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020010001ce6914b43705dea9";
		}else if("001001".equals(tradeCode)){
			return "005b600018000060220000087502000020000100c0801100031600113132333435363738393132202020202020202020202020202020202020202030353531303032372020202020202020202020203135360010014f168653e11538fa";
		}else if("001002".equals(tradeCode)){
			return "008960001800006022000008750200502200810cc09011000000000001000003173130303030303030303030303030303000001131323334353637383931321203090002314106cbefd3c0c7bf2020202020202020202020202020202020202020303535313030323720202020202020202020202031353682175b704f17c508001002e363cf2009be17c5";
		}else if("009001".equals(tradeCode)){
			return "005c600018000060220000087502000020000100c08011000312001230313032303030303132333420202020202020202020202020202020202020203035353130303237202020202020202020202020313536009001bb1de335f6701945";
		}else if("009002".equals(tradeCode)){
			return "008460001800006022000008750200502200810cc09011000000000001000003133130303030303030303030303030303000001230313032303030303132333412030900023137002020202020202020202020202020202020202020303535313030323720202020202020202020202031353682175b704f17c508009002de87121c5758cfd5";
		}else if("008001".equals(tradeCode)) {
			return "005f600018000060220000087502000020000100c08011000026001534303030323030313031303830323020202020202020202020202020202020202020203035303038383838202020202020202020202020313536008001d594c5f5a01d0981";			
		}else if("008002".equals(tradeCode)) {
			return "008d60001800006022000008750200502200810cc0901100000000001000000027313030303030303030303030303030300000153430303032303031303130383032301203140019969206c2edb4bab7ef20202020202020202020202020202020202020203035303038383838202020202020202020202020313536d410c3c165ed00dd00800211d875dd2e9781f5";
		}else{ 
			return "";
		}
	}
	
	public String[]  hasTradeCode() {
		String tradeCode[]  = {
				"001001",
				"001002",
				"009001",
				"009002",
		};
		
		return tradeCode;		
	}
}


